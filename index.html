<!doctype html>
<!-- GITHUB PAGES - LAST UPDATED 2013 - 01 -17 -->
<html lang="en">
<head>
<meta charset="UTF-8">
<!--
  * Kafene Bookmarklet Combiner
  * Copyright 2012 kafene.org <http://kafene.org>
  * @todo - github link
  *
  * COPYRIGHT (c) 2013 kafene.org <http://kafene.org/COPYING>
  * You may do anything with this work that any copyright law would normally
  * restrict, so long as you retain the above notice in all redistributed copies
  * and/or derived works. The works are provided `as-is` with no form of warranty.
  *
  * This program is a rewrite of, and inspired by
  * W-Shadow Bookmarklet Combiner:
    * http://w-shadow.com/bookmarklet-combiner/
    * http://w-shadow.com/blog/2010/06/02/bookmarklet-combiner/
  *
  * @todo - use json for serializing bookmarklets, not custom format.
-->
<meta name="robots" content="noindex,nofollow">
<title>Kafene Bookmarklet Combiner</title>
<style>
  * {
    box-sizing:border-box !important;
  }
  html {
    overflow-y:scroll;
    font:12px/180% "Segoe UI", "Droid Sans", sans-serif;
    padding:0;
    margin:0;
  }
  body {
    background:#f9f9f9;
    padding:0;
    margin:0 auto;
    width:800px;
  }
  header {
    font-weight:bold;
    margin:0.5em 0;
  }
  .info header {
    margin:0;
  }
  img {
    border:0;
    vertical-align:top;
  }
  h1 {
    font-size:1.6em;
    margin:0.5em 0;
    text-align:center;
  }
  form {
    border:1px solid #ccc;
    font-size:1.25em;
    display:block;
    padding:1em;
    background:#fff;
  }
  form > section {
    margin:0.5em 0;
  }
  label {
    margin-left:2px;
    cursor:pointer;
    display:block;
  }
  button {
    display:inline-block;
    line-height:1.25em;
    margin:0;
  }
  input[type="checkbox"], input[type="radio"] {
    margin-right:0.5em;
  }
  section {
    clear:both;
    padding:0.5em;
    border-top:1px dotted #999;
  }
  section:first-of-type {
    padding-top:0;
    border-top:0;
  }

  a {
    text-decoration:none;
    color:#11a;
    cursor:pointer;
  }
  a:hover {
    text-decoration:underline;
  }

  a#combinedBookmarkletLink {
    border:1px solid #ccc;
    background:#eee;
    font-weight:800;
    padding:0.5em;
    border-radius:0.5em;
    color:#000;
    cursor:move;
  }
  a#combinedBookmarkletLink:hover {
    background:#e6e6e6;
    text-decoration:none;
  }

  .settingsColumn {
    display:inline-block;
    text-align:left;
    vertical-align:top;
  }
  .settingsColumn:first-of-type {
    width:37%;
  }
  .settingsColumn:last-of-type {
    width:30%;
    float:right;
  }
  /* Targeting the label for "Show a menu at the"... */
  .settingsColumn:first-of-type label:last-of-type {
    display:inline-block;
  }
  #settingsButtons {
    margin-top:0.25em;
  }
  #settingsButtons button:not(:first-of-type) {
  }
  #settingsTextarea {
    height:16em;
  }

  .info {
    background:#fee;
    border:1px solid #fcc;
    border-radius:0.5em;
    padding:0.5em;
  }
  #info {
    display:none;
  }
  .closeButtonX {
    float:right;
    background:#fcc;
    border:1px solid indianred;
    padding:0 3px;
    content:' \00D7 ';
    cursor:pointer;
    border-radius:0.5em;
    line-height:1;
    padding-bottom:1px;
    margin-top:-0.55em;
    margin-right:-0.55em;
    border-top-left-radius:0;
    border-bottom-right-radius:0;
    color:indianred;
  }
  .closeButtonX:hover {
    background:indianred;
    color:#fff;
  }

  #combinedBookmarkletContainer {
    position:relative;
    margin:0.5em;
    width:100%;
    text-align:center;
    margin-top:-1em;
  }
  #bookmarkIconImage {
    margin-left:0.5em;
    width:24px;
    height:24px;
  }

  #bookmarkletEntryTemplate, #info-restoreSettings, #info-exportSettings, #info-saveSettings {
    display:none;
  }
  #bookmarkletName, #settingsTextarea, #bookmarkletEntry, #bookmarkletEntry input {
    width:100%;
  }

  #bookmarkletEntry {
    margin:0.5em 0;
    background:#eee;
    border-collapse:collapse;
  }
  #bookmarkletEntry, #bookmarkletEntry td, #bookmarkletEntry input {
    border:1px solid #ccc;
  }
  #bookmarkletEntry tr:hover {
    background:#ddd;
  }
  #bookmarkletEntry tr.active {
    background:#fee;
  }
  #bookmarkletEntry td {
    width:100%;
    white-space:nowrap;
    padding:2px 5px;
  }
  #bookmarkletEntry td.titleInput {
    width:35%;
    padding-left:5px;
  }
  #bookmarkletEntry td.moveAndDeleteButtons {
    padding-right:5px;
  }
  button.move {
    font:1.25em/1 monospace;
    display:inline;
    padding:0 2px;
  }
  button.move:hover {
    color:#000;
    cursor:pointer;
  }

  /*
   * http://mystrd.at/modern-clean-css-sticky-footer/
   */
  html {
    position:relative;
    min-height:100%;
  }
  body {
    margin-bottom:2.5em;
  }
  footer {
    position:absolute;
    left:0;
    bottom:0;
    height:2.5em;
    width:100%;
    padding:0.5em 0;
    text-align:center;
  }
  /*
   * ---
   */
</style>
</head>
<body>
<!-- -->
<header>
  <h1>Kafene Bookmarklet Combiner</h1>
</header>
<!-- -->
<form onsubmit="return false;" action="#" id="BookmarkletCombinerForm">
  <section id="bookmarkletEntryContainer">
    <header>Bookmarklets:</header>
    <table id="bookmarkletEntry"></table>
    <!--
     * Template for each row that will be added to #bookmarkletEntry
     * The embedded JS is there so it will be copied on cloneNode()
    -->
    <table id="bookmarkletEntryTemplate">
      <tr class="bookmarklet">
        <td class="titleInput">
          <input type="text" name="title[]" class="title" placeholder="Title"
            onchange="generateBookmarklet();"
            onkeydown="if(event.keyCode==13) return false;">
        </td>
        <td class="urlInput">
          <input type="text" name="url[]" class="url" placeholder="URL"
            onchange="generateBookmarklet();"
            onkeydown="if(event.keyCode==13) return false;">
        </td>
        <td class="moveAndDeleteButtons">
          <button class="move" onclick="moveRow(this,'up');">&uarr;</button>
          <button class="move" onclick="moveRow(this,'down');">&darr;</button>
          <button class="move" onclick="deleteRow(this);">&times;</button>
        </td>
      </tr>
    </table><!-- end #bookmarkletEntryTemplate -->
    <div id="bookmarkletOptions">
      Rows to add (max 10):
      <select name="rowsToAdd" id="rowsToAdd">
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="3">3</option>
        <option value="4">4</option>
        <option value="5">5</option>
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
        <option value="10">10</option>
      </select>
      <button id="addSomeRows">Add Rows</button>
      <div style="float:right">
        <button id="exportSettingsButton">Export Settings</button>
        <a id="exportSettingsInfoLink">[?]</a>
      </div>
    </div>
  </section>
  <!-- Info Boxes. Hidden by default. -->
  <section id="info">
    <div id="info-restoreSettings" class="info">
      <div class="closeButtonX">x</div>
      <header>Restore Settings:</header>
      Restoring your settings collects any detected bookmarklets which have
      been serialized into this program's readable format and entered into the
      "settings" text box, and creates an entry for each one in the "Bookmarklets"
      entry area, as if you had manually entered them to the bookmarklet inputs.
      It then generates the Combined Bookmarklet link based on these restored inputs.
    </div>
    <div id="info-exportSettings" class="info">
      <div class="closeButtonX">x</div>
      <header>Export Settings:</header>
      Exporting your settings the bookmarklets you have entered to combine,
      transforms them into a format which can be loaded later, and fills the
      "settings" text box with these serialized settings.<br>
      It is <strong>strongly recommended</strong> to keep a backup of any exported
      settings that you want to keep long-term, even if you use the "Save Settings" feature.
    </div>
    <div id="info-saveSettings" class="info">
      <div class="closeButtonX">x</div>
      <header>Save Settings:</header>
      This will save your bookmarklets and settings to your browser's localStorage.<br>
      When you come back to this page, they will be restored into the "Settings"
      text box, and you can click "Restore Saved Settings" to load them for editing.<br>
      It is <strong>strongly recommended</strong> to keep a backup of the exported settings,
      or they may be lost by clearing your browser's localStorage
      (often a part of a browser's "clear private data" procedure).<br>
      If your browser does not support localStorage, saving will not work.
    </div>
  </section>
  <!--  -->
  <section>
    <div class="settingsColumn">
      <header>When clicked...</header>
      <label>
        <input type="radio" name="act" id="run">
        Run all bookmarklets
      </label>
      <label>
       <input type="radio" name="act" id="menu" checked="checked">
       Show a menu at the
      </label>
      <select name="position" id="position">
        <option value="tl">top left</option>
        <option value="tr">top right</option>
        <option value="bl">bottom left</option>
        <option value="br">bottom right</option>
        <option value="c">center</option>
      </select>
    </div>
    <div class="settingsColumn">
      <header>Close menu after...</header>
      <label>
        <input id="closeOnClickingLink" type="checkbox" checked>
        Clicking an item
      </label>
      <label>
        <input id="closeOnClickingOutside" type="checkbox" checked>
        Clicking outside it
      </label>
    </div>
    <div class="settingsColumn">
      <header>Name:</header>
      <input type="text" id="bookmarkletName" placeholder="Combined Bookmarklet">
    </div>
  </section>
  <!-- Combined Bookmarklet Link -->
  <section class="combinedBookmarklet">
    <header>Your Bookmarklet:</header>
    <div id="combinedBookmarkletContainer">
      <a href="#" id="combinedBookmarkletLink" title="Combined Bookmarklet">
        <span id="bookmarkletTitle">/!\ Loading /!\</span>
        <img src="#" id="bookmarkIconImage" alt="nt">
      </a>
    </div>
  </section>
  <!-- Settings Form and Restore/Save/Forget Buttons -->
  <section>
    <header>Settings:</header>
    <textarea id="settingsTextarea"></textarea>
    <div id="settingsButtons">
      <button id="restoreSettingsButton">Restore Saved Settings</button>
      <a id="restoreSettingsInfoLink">[?]</a>
      <span id="localStorageOnly">
        <button id="saveSettingsButton">Save Settings</button>
        <a id="saveSettingsInfoLink">[?]</a>
        <button id="removeLocalSettingsButton" style="float:right">Forget Saved Settings</button>
      </span>
    </div>
  </section>
</form>
<!--  -->
<script>
  /*jshint laxbreak:true, laxcomma:true */

  /*
   * Shortcut func to get elementById from document or node
   */
  function d(el, fromNode) { "use strict";
    return (fromNode || document).getElementById(el);
  }

  /*
   * Collect bookmarklets from input fields into an array of objects
   */
  function getBookmarkletsFromInputs()
  { "use strict";
    var bookmarkletEntryTable = d('bookmarkletEntry')
      , bookmarkletInputs = bookmarkletEntryTable.getElementsByTagName('input')
      , bookmarklets = []
      , titles = []
      , urls = []
      , title
      , url
    ;
    /* Collect Titles and URLs from bookmarklet Entry fields */
    for(var i = 0; i < bookmarkletInputs.length; i++)
    {
      if(bookmarkletInputs[i].className.indexOf('title') !== -1) {
        titles.push(bookmarkletInputs[i]);
      }
      if(bookmarkletInputs[i].className.indexOf('url') !== -1) {
        urls.push(bookmarkletInputs[i]);
      }
    }
    for(var j = 0; j < bookmarkletInputs.length; j++)
    {
      title = titles[j] ? titles[j].value : '';
      url = urls[j] ? urls[j].value : '';
      /* If title and URL are empty, skip */
      if(!title && !url) {
        continue;
      }
      /* If there's no title, use first 32 chars of URL */
      if(!title) {
        title = url.length > 32 ? url.substr(0, 32) + '...' : url;
      }
      /*
       * urlencoded "javascript:" urls break "run" setting,
       * so decode them. most unencoded bookmarklets have 1+
       * space inside, decode any without one, and fix unencoded % signs
       */
      if(url.match(/^\s*javascript:/i) && !url.match(/[^\s]\s/)) {
        url = decodeURI(url.replace(/%([^\d]|$)/g, "%25"));
      }
      /* Add titles and urls to bookmarklets array */
      bookmarklets.push({
        'title': title
      , 'url': url && !!url ? url : '#'
      });
    }
    /* Fix for empty results, put something at least */
    if(bookmarklets.length < 1) {
      bookmarklets.push({
        /* 160 = non-breaking space */
        'title': String.fromCharCode(160)
      , 'url': '#'
      });
    }
    return bookmarklets;
  }

  /*
   * Begin Bookmarklet Combiner
   */
  function generateBookmarklet()
  { "use strict";
    /*jshint scripturl:true */
    // console.log('generateBookmarklet() called.');
    var bookmarkletLink = '#'
      , clickActionSetting = d('run').checked ? 'run' : 'menu'
    ;
    var bookmarklets = getBookmarkletsFromInputs();
    /* Remove any showing bookmarklet menus  */
    var bookmarkletContainer = document.getElementsByClassName('kafeneCombinedBookmarkletContainer');
    for(var bcI = 0; bcI < bookmarkletContainer.length; bcI++) {
      try {
        bookmarkletContainer[bcI].parentNode.removeChild(bookmarkletContainer[bcI]);
      } catch(err) {}
    }
    /* The meta-bookmarklet that displays bookmarklet menu */
    if(clickActionSetting === 'menu')
    {
      bookmarklets =
      [ JSON.stringify(bookmarklets)
      , '"' + d('position').value + '"'
      , d('closeOnClickingLink').checked
      , d('closeOnClickingOutside').checked
      , (new Date()).getTime()
      ];
      /* @todo - could use Function.prototype.toString() here? */
      bookmarkletLink =
        'javascript:(function(bookmarklets,posopt,ccl,cco,utime)'
      + '{'
      + 'var doc=document,bmid="kafeneCombinedBookmarklet-"+utime'
      +     ',menu=doc.getElementById(bmid)'
      +     ',cssid="kafeneCombinedBookmarkletStyle-"+utime'
      +     ',styleel=doc.getElementById(cssid),bmlink'
      /* Bookmarklet position */
      +     ',pos={'
      +         'tl:{left:"10px",top:"10px"},'
      +         'tr:{right:"10px",top:"10px"},'
      +         'bl:{left:"10px",bottom:"10px"},'
      +         'br:{right:"10px",bottom:"10px"}'
      +     '}'
      /* Main CSS */
      +     ',css=".kafeneCombinedBookmarkletContainer{'
      +         'position:fixed!important;z-index:9001!important;width:250px;'
      +         'max-height:450px!important;overflow-y:auto!important;'
      +         'border-radius:3px;display:block!important;visibility:hidden;'
      +         'background:#fff!important;padding:3px!important;'
      +         'border:1px solid #b0b0b0!important;text-align:left!important;'
      +         'box-shadow:2px 2px 3px #777!important;'
      +         'overflow-x:hidden!important;'
      +     '}.kafeneCombinedBookmarkletContainer a{display:block!important;width:100%;'
      +         'border:0!important;background:#fff!important;'
      +         'margin:0!important;color:#000!important;'
      +         'padding:4px 0 4px 6px!important;word-spacing:normal!important;'
      +         'word-spacing:normal!important;'
      +         'font:normal normal normal 14px/100% '
      +         '\'Segoe UI\',\'Droid Sans Mono\',Verdana,sans-serif !important;'
      +         'letter-spacing:normal!important;text-decoration:none!important;'
      +     '}.kafeneCombinedBookmarkletContainer a:hover{'
      +         'background:#a0a0a0!important;color:#fff!important;'
      +         'text-decoration:none!important;'
      +         'font:normal normal normal 14px/100% '
      +         '\'Segoe UI\',\'Droid Sans Mono\',Verdana,sans-serif !important;'
      +         'letter-spacing:normal!important;border:0!important;'
      +     '}";'
      /* End Main CSS */
      /*
       * When clicking the bookmarklet from browser UI,
       * show it if it's not showing, hide it if it is.
      */
      + 'function hid(){menu.style.visibility="hidden"}'
      + 'function vis(){menu.style.visibility="visible"}'
      + 'if(menu){'
      +     'if(menu.style.visibility=="visible"){hid()}else{vis()}'+'return;'
      + '}'
      /* Create bookmarklet + styles */
      + 'if(!styleel){'
      +     'css=css.replace(/\\.kafeneCombinedBookmarkletContainer/g,"#"+bmid);'
      +     'styleel=doc.createElement("style");'
      +     'styleel.id=cssid;'
      +     'styleel.appendChild(doc.createTextNode(css));'
      +     'doc.getElementsByTagName("head")[0].appendChild(styleel);'
      + '}'
      + 'menu=doc.createElement("div");'
      + 'menu.setAttribute("id",bmid);'
      + 'menu.className="kafeneCombinedBookmarkletContainer";'
      + 'for(var o=0;o<bookmarklets.length;o++){'
      +     'bmlink=doc.createElement("a");'
      +     'bmlink.appendChild(doc.createTextNode(bookmarklets[o].title));'
      +     'bmlink.setAttribute("href",bookmarklets[o].url);'
      +     'bmlink.onclick=(function(ev){if(ccl){hid()}});'
      +     'menu.appendChild(bmlink);'
      + '}'
      + 'doc.getElementsByTagName("body")[0].appendChild(menu);'
      + 'if(pos.hasOwnProperty(posopt)){'
      +     'for(var j in pos[posopt])'+'menu.style[j]=pos[posopt][j];'
      + '}else{'
      +     'if(posopt=="c"){'
      +         'menu.style.left=Math.round((window.innerWidth-menu.offsetWidth)/2)+"px";'
      +         'menu.style.top=Math.round((window.innerHeight-menu.offsetHeight)/2)+"px";'
      +     '}'
      + '}'
      + 'if(cco){'
      +     'var oclick = doc.onclick;'
      +     'doc.onclick=(function(){'
      +         'hid();'
      +         'if(typeof oclick=="function"){oclick()}'
      +     '});'
      +     'menu.onclick=(function(i){'
      +         'i.stopPropagation()'
      +     '});'
      + '}'
      + 'vis();'
      + '})('+bookmarklets.join(',')+')';
    /* meta-bookmarklet that runs all bookmarklets at once */
    }
    else if(clickActionSetting === 'run')
    {
      bookmarkletLink =
        'javascript:(function(bookmarklets)'
      + '{'
      + 'for(var i=0;i<bookmarklets.length;i++){'
      +     'var code=bookmarklets[i].url;'
      +     'if(code.indexOf("javascript:")!=-1){'
      +         'code=code.replace("javascript:","");'
      +         'eval(code)'
      +     '}else{'
      +         'code=code.replace(/^\\s+|\\s+$/g,"");'
      +         'if(code.length>0){'
      +             'window.open(code);'
      +         '}'
      +     '}'
      + '}'
      + '})('+JSON.stringify(bookmarklets)+')';
    }
    /* Set result link to the generated bookmarklet */
    d('combinedBookmarkletLink').href = encodeURI(bookmarkletLink);
  }

  /* Toggle showing info when an info link is clicked */
  function showInfo(x)
  { "use strict";
    try {
      var infoItem = d('info-' + x)
        , infoContainer = d('info')
      ;
      var infoChildren = infoContainer.children;
      if(infoChildren.length) {
        for(var i = 0; i < infoChildren.length; i++) {
          infoChildren[i].style.display = 'none';
        }
      }
      infoContainer.style.display = 'block';
      infoItem.style.display = 'block';
    } catch(err) {}
  }

  /*
   * InsertAfter function
   * http://www.dzone.com/snippets/insertafter-insertbefore-and
   */
  function insertAfter(newNode, refNode, node)
  { "use strict";
    try {
      if(typeof(refNode.nextSibling) === 'object') {
        newNode.insertBefore(refNode, node.nextSibling);
      } else {
        newNode.appendChild(refNode);
      }
    } catch(err) {}
  }

  /*
   * Get an element's nearest containing tag of a certain tag name
   * (if it has one)
   */
  function getParentTag(tag, el)
  { "use strict";
    var test = el.parentNode;
    while(test.parentNode && (test.nodeName.toLowerCase() !== tag)) {
      test = test.parentNode;
    }
    return test.nodeName.toLowerCase() === tag ? test : '';
  }

  /* Update the bookmarklet's title. */
  function updateTitle()
  { "use strict";
    // console.log('updateTitle() called.');
    d('bookmarkletTitle').innerText = d('combinedBookmarkletLink').title = d('bookmarkletName').value
      ? d('bookmarkletName').value
      : 'Combined Bookmarklet';
  }

  /* Add a bookmarklet input row */
  function addRow(ev, howMany)
  { "use strict";
    if(ev && ev.preventDefault) {
      ev.preventDefault();
    }
    var rta = document.getElementsByName('rowsToAdd')[0]
      , tpl = d('bookmarkletEntryTemplate');
    if(rta.value && !howMany) {
      howMany = rta.value; 
    }
    tpl = tpl.getElementsByClassName('bookmarklet')[0];
    for(var i = 0; i < howMany; i++) {
      d('bookmarkletEntry').appendChild(tpl.cloneNode(true));
    }
  }

  /*
   * Restore saved settings
   */
  function restoreSettings(ev)
  { "use strict";
    // console.log('restoreSettings() called.');
    if(ev && ev.preventDefault) {
      ev.preventDefault();
    }
    var combinedJSON = d('settingsTextarea').value.toString().trim()
      , settings
      , bookmarklets
      , combined;
    if(!combinedJSON) {
      return false;
    }
    try {
      combined = JSON.parse(combinedJSON);
    } catch(err) {
      window.alert("Invalid settings format! JSON.parse() failed.");
      return false;
    }
    settings = combined.settings;
    bookmarklets = combined.bookmarklets;
    /* Restore setting for run vs show menu */
    if(settings.onclick === 'run') {
      d('run').checked = true;
    } else {
      d('menu').checked = true;
    }
    /* Restore setting for Menu position (position element id = saved position) */
    try {
      d(settings.position).selected = true;
    } catch(err) {}
    /* Restore setting for closing on clicking an item */
    try {
      d('closeOnClickingLink').checked = settings.closeOnClickingLink;
    } catch(err) {}
    /* Restore setting for closing an item when clicking outside menu */
    try {
      d('closeOnClickingOutside').checked = settings.closeOnClickingOutside;
    } catch(err) {}
    /* Restore name */
    d('bookmarkletName').value = settings.name || '';
    /*
     * Make #bookmarkletEntry empty, add empty rows.
     * Number of rows to add = number of lines in settings.
     */
    d('bookmarkletEntry').innerHTML = '';
    addRow(null, bookmarklets.length);
    var bookmarkletEntryTable = d('bookmarkletEntry');
    var entryUrls = bookmarkletEntryTable.getElementsByClassName('url')
      , entryTitles = bookmarkletEntryTable.getElementsByClassName('title')
    ;
    try {
      for(var i = 0; i < bookmarklets.length; i++) {
        entryTitles[i].value = bookmarklets[i].title || '';
        entryUrls[i].value = bookmarklets[i].url || '';
      }
    } catch(err) {}
    /* Update the title and generate a new bookmarklet. */
    updateTitle();
    generateBookmarklet();
    /* Scroll to bottom of page, so settings box remains visible */
    try {
      window.scrollTo(0, document.body.scrollHeight);
    } catch(err) {}
  }

  /*
   * Exports the current bookmarklets into the settings textarea
   */
  function exportSettings(ev)
  { "use strict";
    // console.log('exportSettings() called.');
    if(ev && ev.preventDefault) {
      ev.preventDefault();
    }
    var exports = {}
      , bookmarkletEntryTable = d('bookmarkletEntry')
      , title
      , url
      , j = 0
      , settingsTextarea = d('settingsTextarea')
      , exportButton = d('exportSettingsButton')
      , urls = bookmarkletEntryTable.getElementsByClassName('url')
      , titles = bookmarkletEntryTable.getElementsByClassName('title')
    ;
    exports.bookmarklets = [];
    /* Get all URLs and Titles into exports.bookmarklets[] */
    for(var i = 0; i < urls.length; i++) {
      try {
        exports.bookmarklets[i] = {};
        title = titles[i].value;
        url = urls[i].value;
        /* Don't export empty items */
        if(title.trim() === '' && url.trim() === '') {
          continue;
        } else {
          exports.bookmarklets[i].title = title.trim();
          exports.bookmarklets[i].url = url.trim();
          j++;
        }
      } catch(err) {}
    }
    /* Flash a warning if there was nothing to export */
    if(j === 0) {
      exportButton.innerText = 'Nothing to export!';
      setTimeout(function(){
        exportButton.innerText = 'Export Settings';
      }, 1500);
      return;
    } else {
      /* Clear settings textarea */
        settingsTextarea.innerHTML
      = settingsTextarea.innerTetxt
      = settingsTextarea.textContent
      = '';
      /* Add the current page settings (see serializeSettings()) */
      exports.settings = serializeSettings();
      // console.log(exports);
      /* insert into the settings textarea */
        settingsTextarea.innerHTML
      = settingsTextarea.innerText
      = settingsTextarea.textContent
      = JSON.stringify(exports).trim();
      /* Select the settings text (presumably to copy/paste) */
      settingsTextarea.select();
    }
    generateBookmarklet();
  }

  /*
   * Save the current settings
   * saves the state of the page to the browser's localStorage
   */
  function saveSettings(ev)
  { "use strict";
    // console.log('saveSettings() called.');
    if(ev && ev.preventDefault) {
      ev.preventDefault();
    }
    var saveButton = d('saveSettingsButton')
      , val = d('settingsTextarea').innerText || d('settingsTextarea').innerHTML
    ;
    /*
     * Flash a "settings saved" message in the save button
     * or if the settings field was empty, warn that nothing was there
     */
    if(val !== '' && val !== null) {
      try {
        localStorage.setItem('kafeneBookmarkletCombinerSettings', val);
        saveButton.innerText = 'Settings saved!';
        setTimeout(function(){
          saveButton.innerText = 'Save Settings';
        }, 1500);
      } catch(err) {}
    } else {
      saveButton.innerText = 'Nothing to save!';
      setTimeout(function(){
        saveButton.innerText = 'Save Settings';
      }, 1500);
      return;
    }
    /* Regenerate the bookmarklet */
    generateBookmarklet();
  }

  /*
   * Serialize current settings into an object.
   */
  function serializeSettings()
  { "use strict";
    // console.log('serializeSettings() called.');
    var settings = {}
      , pos = 'position';
    if(d('menu').checked) {
      settings.onclick = "menu";
      settings.position = d(pos).value;
    } else {
      settings.onclick = "run";
    }
    try {
      settings.closeOnClickingLink = d('closeOnClickingLink').checked;
    } catch(err) {}
    try {
      settings.closeOnClickingOutside = d('closeOnClickingOutside').checked;
    } catch(err) {}
    if(!!d('bookmarkletName').value) {
      settings.name = d('bookmarkletName').value;
    }
    return settings;
  }

  /*
   * Remove settings from localStorage
   */
  function removeLocalSettings(ev)
  { "use strict";
    // console.log('removeLocalSettings() called.');
    if(ev && ev.preventDefault) {
      ev.preventDefault();
    }
    var settings = d('settingsTextarea');
    /* Confirm dialog if the settings textarea is not empty */
    if(settings.innerText.trim() === '' || window.confirm('OK?')) {
      localStorage.removeItem('kafeneBookmarkletCombinerSettings');
    } else {
      return;
    }
  }

  /*
   * Remove a row from the bookmarklet inputs
   */
  function deleteRow(row)
  { "use strict";
    row = getParentTag('tr', row);
    if(!window.confirm('Are you sure you want to remove this row?')) {
      return;
    }
    try {
      row.parentElement.removeChild(row);
    } catch(err) {}
    /* Regenerate the bookmarklet */
    generateBookmarklet();
  }

  /*
   * Remove "active" class from all rows that it's set on
   */
  function deactivateRows()
  { "use strict";
    var bookmarkletEntryTable = d('bookmarkletEntry');
    var rows = bookmarkletEntryTable.getElementsByTagName('tr');
    if(rows.length) {
      for(var i = 0; i < rows.length; i++) {
        rows[i].className = rows[i].className.replace(' active', '');
      }
    }
  }

  /*
   * Move a table row in direction `dir` ("up"/true or it assumes down)
   */
  function moveRow(rowToMove, dir)
  { "use strict";
    var up = (dir === 'up' || dir === true) ? true : false
      , row = getParentTag('tr', rowToMove)
    ;
    var node = row.cloneNode(true)
      , parent = row.parentElement
      , buttonIndex = up ? 0 : 1
      , sibling = up ? row.previousElementSibling : row.nextElementSibling
    ;
    /* Clear "active" class from active rows */
    deactivateRows();
    /* Set "active" class on clicked row, for one second to help visual tracking */
    node.className = node.className.replace(' active', '') + ' active';
    setTimeout(function(){
      node.className = node.className.replace(' active','');
    }, 1000);
    /* If we're going up and there's a row before it, insert it before */
    if(up && typeof(sibling) === 'object') {
      parent.insertBefore(node, sibling);
      parent.removeChild(row);
    }
    /* Otherwise (still if going up), ... @todo */
    else if(up) {
      parent.removeChild(row);
      insertAfter(sibling, row, parent.firstElementChild);
    }
    /* Similar to above but for going down */
    if(!up && sibling !== null) {
      insertAfter(parent, node, sibling);
      parent.removeChild(row);
    }
    else if(!up) {
      parent.removeChild(row);
      parent.insertBefore(node, parent.firstElementChild);
    }
    /*
     * Focus the row's up button so you can press Return repeatedly to move up
     * This also seems to have the benefit of keeping the window scrolling
     * if the row would otherwise go above/below the viewport
     */
    try {
      node.getElementsByTagName('button')[buttonIndex].focus();
    } catch(err) {}
    /* Regenerate the bookmarklet with the links reordered */
    generateBookmarklet();
  }

  /*
   * Initial loading and set up listeners
   * . Many listeners to regenerate the bookmarklet when a setting is changed.
   */
  window.addEventListener('load', function()
  { "use strict";
    /* */
    d('position').addEventListener('change', function(){
      generateBookmarklet();
    });
    /* If menu position is changed, make sure the "show menu" setting is selected */
    /* @todo - should this event be "select" instead? */
    d('position').addEventListener('click', function(){
      d('menu').checked = true;
    });
    /* */
    d('run').addEventListener('change', function(){
      generateBookmarklet();
    });
    /* */
    d('menu').addEventListener('change', function(){
      generateBookmarklet();
    });
    /* */
    d('closeOnClickingLink').addEventListener('change', function(){
      generateBookmarklet();
    });
    /* */
    d('closeOnClickingOutside').addEventListener('change', function(){
      generateBookmarklet();
    });
    /* Update the title of the bookmarklet when name is changed */
    d('bookmarkletName').addEventListener('change', function(){
      updateTitle();
    });
    /* For some reason pressing enter here was moving rows up/down */
    d('bookmarkletName').addEventListener('keyDown', function(ev){
      if(ev && ev.keyCode === 13 && ev.preventDefault) {
        ev.preventDefault();
      }
    });
    /* Same as Above */
    d('position').addEventListener('keyDown', function(ev){
      if(ev && ev.keyCode === 13 && ev.preventDefault) {
        ev.preventDefault();
      }
    });
    /* Same as Above */
    d('rowsToAdd').addEventListener('keyDown', function(ev){
      if(ev && ev.keyCode === 13 && ev.preventDefault) {
        ev.preventDefault();
      }
    });
    /* Add an input row when the add button is clicked */
    d('addSomeRows').addEventListener('click', function(ev){
      addRow(ev);
    });
    /* */
    d('exportSettingsButton').addEventListener('click', function(ev){
      exportSettings(ev);
    });
    /* */
    d('restoreSettingsButton').addEventListener('click', function(ev){
      restoreSettings(ev);
    });
    /* */
    d('saveSettingsButton').addEventListener('click', function(ev){
      saveSettings(ev);
    });
    /* */
    d('removeLocalSettingsButton').addEventListener('click', function(ev){
      removeLocalSettings(ev);
    });
    /* */
    d('restoreSettingsInfoLink').addEventListener('click', function(){
      showInfo('restoreSettings');
    });
    /* */
    d('saveSettingsInfoLink').addEventListener('click', function(){
      showInfo('saveSettings');
    });
    /* */
    d('exportSettingsInfoLink').addEventListener('click', function(){
      showInfo('exportSettings');
    });
    /* This is a dummy I put in to make jshint happy. */
    var jsHintStopWarningMe = false;
    if(jsHintStopWarningMe) {
      deleteRow();
      moveRow();
    }
    /*
     * Below is Initial setup performed once on load
     */
    /* Only show the save buttons to browsers that support localStorage */
    d('localStorageOnly').style.display = window.localStorage
      ? 'inline'
      : 'none';
    /* When clicking on a close button (used in info area), hide info area */
    var closeButtons = document.getElementsByClassName('closeButtonX');
    var closeInfoBox = function(ev){
      if(ev && ev.preventDefault) {
        ev.preventDefault();
      }
      document.getElementById('info').style.display = 'none';
    };
    for(var cbI = 0; cbI < closeButtons.length; cbI++) {
      closeButtons[cbI].onclick = closeInfoBox;
    }
    /* Base64-encoded Bookmark Icon Image (shown in bookmarklet link) */
    d('bookmarkIconImage').src =
       'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYAQMAA'
      + 'ADaua+7AAAABlBMVEUAAAD///+l2Z/dAAAAAnRSTlP/AOW3MEoAAABRSURBVHjaFcmxCcAgFE'
      + 'XRKxaWjuAorpQyReA7mqMILmBpEXz5KQ487mNLLBOjil5Ey4Lkou/gDf8wFpVN4SVzSF4jswV'
      + 'mhzkMLne7x5jH6acPX8EmudSRfWIAAAAASUVORK5CYII=';
    /* Changes the bookmarklet title from "Loading" to "Combined Bookmarklet" */
    updateTitle();
    /*
     * Gets any settings settings from browser's localStorage
     * and fill them in to the settings textarea
     */
    var settings = d('settingsTextarea')
      , localSettings = localStorage.getItem('kafeneBookmarkletCombinerSettings');
    if(localSettings !== null) {
        settings.innerHTML
      = settings.innerText
      = settings.textContent
      = localStorage.getItem('kafeneBookmarkletCombinerSettings');
    }
    /* Initialize 3 input rows */
    addRow(0, 3);
    /* generate bookmarklet (in case settings were loaded) */
    generateBookmarklet();
  });
</script>
<!--  -->
<footer>
  <a href="http://kafene.org/COPYING">&copy; 2012</a>
  -
  <a href="http://kafene.org/">kafene.org</a>
</footer>
</body>
</html>
